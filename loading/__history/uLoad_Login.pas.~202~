unit uLoad_Login;

interface

uses
  System.Classes,
  System.SysUtils,
  System.UiTypes,
  System.DateUtils,
  System.JSON,
  FMX.Forms,
  FMX.Types,
  IdExplicitTLSClientServerBase,
  IdSMTP,
  IdSSLOpenSSL,
  IdMessage,
  IdGlobal,
  Rest.Types,
  BASS;

procedure Login;
procedure Exit_Program;

procedure Change_User(vUser_Num: Integer);

procedure Update_Password(vValue: String);

procedure Show_Password;
procedure CapsLock(vActive: Boolean);

procedure Add_user_after_registration;

implementation

uses
  load,
  uWindows,
  uLoad,
  uLoad_AllTypes,
  uLoad_SetAll,
  uDB,
  uDB_AUser,
  uInternet_Files;

var
  vPassword_Count: Integer;

procedure Login;
begin
  ex_load.Scene.Progress.Visible := True;
  ex_load.Scene.Progress_Text.Visible := True;
  if (ex_load.Login.User_V.Items.Strings[ex_load.Login.User_V.ItemIndex] = uDB_AUser.Local.Username) and (ex_load.Login.Pass_V.Text = uDB_AUser.Local.Password) then
    uLoad.Start_ExtraFE
  else
  begin
    if (ex_load.Login.User_V.Items.Strings[ex_load.Login.User_V.ItemIndex] = uDB_AUser.Local.Username) then
      ex_load.Login.Warning.Text := 'Password is incorrect';
    ex_load.Login.Warning.Visible := True;
    ex_load.Login.Forget_Pass.Visible := True;
    ex_load.Login.Panel_Login_Error.Start;
    BASS_ChannelStop(sound.str_fx.general[0]);
    BASS_ChannelSetPosition(sound.str_fx.general[0], 0, 0);
    BASS_ChannelPlay(sound.str_fx.general[1], false);
  end;
end;

procedure Exit_Program;
begin
  if extrafe.databases.online_connected then
  begin
    uDB.ExtraFE_DB.Disconnect;
    FreeAndNil(uDB.ExtraFE_DB);
  end;
  uDB.ExtraFE_DB_Local.Connected := false;
  FreeAndNil(uDB.ExtraFE_DB_Local);
  Application.Terminate;
end;

procedure Show_Password;
begin
  if ex_load.Login.Pass_V.Password then
  begin
    ex_load.Login.Pass_Show.Text := #$e9ce;
    ex_load.Login.Pass_Show.TextSettings.FontColor := TAlphaColorRec.Deepskyblue;
    BASS_ChannelStop(sound.str_fx.general[5]);
    BASS_ChannelSetPosition(sound.str_fx.general[5], 0, 0);
    BASS_ChannelPlay(sound.str_fx.general[4], false);
  end
  else
  begin
    ex_load.Login.Pass_Show.Text := #$e9d1;
    ex_load.Login.Pass_Show.TextSettings.FontColor := TAlphaColorRec.Blueviolet;
    BASS_ChannelStop(sound.str_fx.general[4]);
    BASS_ChannelSetPosition(sound.str_fx.general[4], 0, 0);
    BASS_ChannelPlay(sound.str_fx.general[5], false);
  end;
  ex_load.Login.Pass_V.Password := not ex_load.Login.Pass_V.Password;
end;

procedure CapsLock(vActive: Boolean);
begin
  vActive := not vActive;
  if vActive then
  begin
    ex_load.Login.CapsLock_Icon.TextSettings.FontColor := TAlphaColorRec.Deepskyblue;
    ex_load.Login.CapsLock_Icon.Font.Size := 36;
    ex_load.Login.CapsLock.Text := 'Caps lock is Active';
  end
  else
  begin
    ex_load.Login.CapsLock_Icon.TextSettings.FontColor := TAlphaColorRec.Grey;
    ex_load.Login.CapsLock_Icon.Font.Size := 24;
    ex_load.Login.CapsLock.Text := 'Caps lock is Inactive';
  end;
  ex_load.Login.CapsLock_Icon.Locked := vActive;
end;

procedure Update_Password(vValue: String);
begin
  vPassword_Count := Length(vValue);

  if ex_load.Login.Warning.Visible then
  begin
    ex_load.Login.Warning.Visible := false;
    ex_load.Login.Forget_Pass.Visible := false;
  end;

  if vPassword_Count > 0 then
  begin
    if ex_load.Login.Pass_V.Password then
      ex_load.Login.Pass_Show.TextSettings.FontColor := TAlphaColorRec.Blueviolet
    else
      ex_load.Login.Pass_Show.TextSettings.FontColor := TAlphaColorRec.Deepskyblue;
  end
  else
    ex_load.Login.Pass_Show.TextSettings.FontColor := TAlphaColorRec.Grey;

end;

procedure Change_User(vUser_Num: Integer);
begin
  if extrafe.databases.online_connected then
  begin
    if vUser_Num <> 0 then
    begin
      ex_load.Login.Avatar.Bitmap.LoadFromFile(ex_main.Paths.Avatar_Images + vLogin_User[vUser_Num].Avatar + '.png');
      ex_load.Login.Last_Visit.Text := 'Last Visit : ' + vLogin_User[vUser_Num].Last_Visit;
      uDB_AUser.Get_Local_Data((vUser_Num).ToString);
      // Get online data
    end
    else
    begin
      ex_load.Login.Avatar.Bitmap.LoadFromFile(ex_main.Paths.Avatar_Images + '0.png');
      ex_load.Login.Last_Visit.Text := 'Last Visit : --/--/--';
    end
  end
  else
  begin
    // Exception (if not connectet to internet or online database)
  end;
end;

procedure Add_user_after_registration;
if extrafe.users_total > 0 then
  begin
    for vi := 1 to extrafe.users_total do
    begin
      vLogin_User[vi].Username := uDB.Query_Select(uDB.ExtraFE_Query_Local, 'USERNAME', 'USERS', 'USER_ID', vi.ToString);
      vLogin_User[vi].Password := uDB.Query_Select(uDB.ExtraFE_Query_Local, 'PASSWORD', 'USERS', 'USER_ID', vi.ToString);
      vLogin_User[vi].Avatar := uDB.Query_Select(uDB.ExtraFE_Query_Local, 'AVATAR', 'USERS', 'USER_ID', vi.ToString);
      vLogin_User[vi].Last_Visit := uDB.Query_Select(uDB.ExtraFE_Query_Local, 'LAST_VISIT', 'USERS', 'USER_ID', vi.ToString);

      vListBox_Item[vi] := TListBoxItem.Create(ex_load.Login.User_V);
      vListBox_Item[vi].Name := 'Load_ListItem_' + vi.ToString;
      vListBox_Item[vi].Parent := ex_load.Login.User_V;
      vListBox_Item[vi].StyledSettings := vListBox_Item[vi].StyledSettings - [TStyledSetting.FontColor, TStyledSetting.Size];
      vListBox_Item[vi].TextSettings.FontColor := TAlphaColorRec.Deepskyblue;
      vListBox_Item[vi].Font.Size := 18;
      vListBox_Item[vi].Text := vLogin_User[vi].Username;
      vListBox_Item[vi].Visible := True;
      ex_load.Login.User_V.AddObject(vListBox_Item[vi]);
    end;
  end;
end.
